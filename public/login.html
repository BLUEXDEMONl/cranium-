<!-- cranium/public/login.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Cranium - Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg: linear-gradient(-45deg,#0f0c29,#302b63,#24243e,#0f0c29);
      --glass: rgba(255,255,255,.08);
      --accent: #7c3aed;
    }
    @font-face {
      font-family: 'Gagalin';
      src: url('./media/gagalin.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }
    *{box-sizing:border-box;font-family:"Gagalin",system-ui,sans-serif}
    body{
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg);
      background-size:400% 400%;
      animation:glow 15s ease infinite;
    }
    @keyframes glow{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .logo{
      display:block;
      margin:0 auto 1.5rem;
      width:100px;
      height:100px;
    }
    .card{
      width:90%;
      max-width:380px;
      padding:2.5rem 2rem;
      border-radius:20px;
      background:var(--glass);
      backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,.1);
      color:#fff;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      transition:transform .3s ease;
    }
    .card:hover{transform:translateY(-4px)}
    h1{text-align:center;margin-bottom:.5rem;font-weight:700;font-size:1.6rem}
    .subtitle{text-align:center;font-size:.85rem;opacity:.6;margin-bottom:2rem}
    label{display:block;margin:.75rem 0 .25rem;font-size:.85rem;opacity:.8}
    input{
      width:100%;
      padding:.8rem 1rem;
      border:none;
      border-radius:10px;
      background:rgba(255,255,255,.1);
      color:#fff;
      outline:none;
      transition:background .25s;
    }
    input:focus{background:rgba(255,255,255,.2)}
    .hint{font-size:.7rem;margin-top:.2rem;opacity:.7}
    .btn{
      width:100%;
      margin-top:1.8rem;
      padding:.9rem;
      border:none;
      border-radius:10px;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:background .25s;
    }
    .btn:hover{background:#6d28d9}
    .btn:disabled{background:#4c1d95;cursor:wait}
    .error{
      margin-top:.75rem;
      font-size:.8rem;
      color:#fca5a5;
      text-align:center;
      animation:shake .4s;
    }
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      75%{transform:translateX(6px)}
    }
    .spinner{
      border:2px solid rgba(255,255,255,.2);
      border-top:2px solid #fff;
      border-radius:50%;
      width:16px;
      height:16px;
      animation:spin .5s linear infinite;
      display:inline-block;
      margin-right:.5rem;
      vertical-align:middle;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .success{
      margin-top:.75rem;
      font-size:.8rem;
      color:#86efac;
      text-align:center;
      animation:fadeIn .5s;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .d-none{display:none!important}
  </style>
</head>
<body>
  <form id="loginForm" class="card">
    <img src="./media/cranium.svg" alt="Cranium" class="logo" />

    <h1>Welcome back</h1>
    <p class="subtitle">Log in to your Cranium account</p>

    <label for="emailOrUsername">Email or Username</label>
    <input id="emailOrUsername" type="text" required autocomplete="username"/>
    <span class="hint" id="emailOrUsernameHint">Enter your email or username</span>

    <label for="password">Password</label>
    <div style="position:relative">
      <input id="password" type="password" required minlength="6"/>
      <button type="button" id="togglePw"
        style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;cursor:pointer;font-size:1.1rem">
        üëÅ
      </button>
    </div>
    <span class="hint" id="pwHint">At least 8 characters</span>

    <button class="btn" id="submitBtn" type="submit">
      <span id="btnText">Sign in</span>
    </button>

    <div id="error" class="error d-none"></div>
    <div id="success" class="success d-none"></div>
    <p style="text-align:center;font-size:.8rem;margin-top:1rem">
      No account? <a href="signup.html" style="color:#c4b5fd">Sign up</a>
    </p>
  </form>

<script>
const form   = document.getElementById('loginForm');
const emailOrUsername = document.getElementById('emailOrUsername');
const pw     = document.getElementById('password');
const emailOrUsernameHint = document.getElementById('emailOrUsernameHint');
const pwHint = document.getElementById('pwHint');
const submitBtn = document.getElementById('submitBtn');
const btnText = document.getElementById('btnText');
const error = document.getElementById('error');
const success = document.getElementById('success');

function showError(msg) {
  error.textContent = msg;
  error.classList.remove('d-none');
  success.classList.add('d-none');
}

function showSuccess(msg) {
  success.textContent = msg;
  success.classList.remove('d-none');
  error.classList.add('d-none');
}

function hideMessages() {
  error.classList.add('d-none');
  success.classList.add('d-none');
}

emailOrUsername.addEventListener('input', () => {
  hideMessages();
  const value = emailOrUsername.value.trim();
  const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  const isUsername = value.length >= 3;
  
  if (!value) {
    emailOrUsernameHint.textContent = 'Enter your email or username';
    emailOrUsernameHint.style.color = '#fca5a5';
  } else if (isEmail || isUsername) {
    emailOrUsernameHint.textContent = isEmail ? '‚úì Valid email' : '‚úì Valid username';
    emailOrUsernameHint.style.color = '#86efac';
  } else {
    emailOrUsernameHint.textContent = 'Enter valid email or username (3+ chars)';
    emailOrUsernameHint.style.color = '#fca5a5';
  }
});

pw.addEventListener('input', () => {
  hideMessages();
  const isValid = pw.value.length >= 8;
  pwHint.textContent = pw.value ? (isValid ? '‚úì Strong enough' : `Need ${8 - pw.value.length} more chars`) : 'At least 8 characters';
  pwHint.style.color = isValid ? '#86efac' : '#fca5a5';
});

document.getElementById('togglePw').addEventListener('click', () => {
  const type = pw.type === 'password' ? 'text' : 'password';
  pw.type = type;
  document.getElementById('togglePw').textContent = type === 'password' ? 'üëÅ' : 'üôà';
});

form.addEventListener('submit', async e => {
  e.preventDefault();
  hideMessages();
  
  if (!emailOrUsername.value.trim() || !pw.value.trim()) {
    showError('Please fill in all fields');
    return;
  }
  
  const value = emailOrUsername.value.trim();
  const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  const isUsername = value.length >= 3;
  
  if (!isEmail && !isUsername) {
    showError('Please enter a valid email or username (3+ characters)');
    return;
  }
  
  if (pw.value.length < 8) {
    showError('Password must be at least 8 characters');
    return;
  }
  
  submitBtn.disabled = true;
  btnText.innerHTML = '<span class="spinner"></span>Signing in‚Ä¶';

  const payload = { emailOrUsername: value, password: pw.value.trim() };
  try {
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.error || 'Login failed');
    }
    
    showSuccess('Login successful! Redirecting...');
    localStorage.setItem('token', data.token);
    localStorage.setItem('user', JSON.stringify(data.user));
    
    setTimeout(() => {
      window.location.href = 'dashboard.html';
    }, 1500);
  } catch (err) {
    showError(err.message || 'Login failed. Please try again.');
    submitBtn.disabled = false;
    btnText.textContent = 'Sign in';
  }
});

if (localStorage.getItem('token')) {
  fetch('/api/verify', {
    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
  }).then(res => {
    if (res.ok) {
      window.location.href = 'dashboard.html';
    }
  }).catch(() => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
  });
}
</script>
</body>
</html>
